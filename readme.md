# landing.js

Скрипт для открытия посадочной страницы по клику с отслеживанием времени последнего визита.

## Описание

Этот JavaScript-скрипт предназначен для открытия посадочной страницы в новой вкладке браузера после того, как пользователь совершит клик по определенным элементам на странице (например, по контейнеру сайта или изображению). Скрипт отслеживает время последнего визита пользователя с помощью `localStorage` и открывает посадочную страницу только в том случае, если с момента последнего визита прошло определенное время (по умолчанию 30 дней). Это позволяет показывать посадочную страницу не чаще, чем раз в месяц.

Скрипт предназначен для использования на сайтах WordPress и требует наличия плагина [Advanced Custom Fields (ACF)](https://www.advancedcustomfields.com/). URL посадочной страницы и другие параметры задаются с помощью пользовательских полей ACF.

**Логика работы скрипта:**

1.  Скрипт проверяет наличие мета-тега с именем `landing-page-url`, который содержит URL посадочной страницы.
2.  Скрипт проверяет, является ли устройство пользователя мобильным. Если устройство мобильное и не включена поддержка открытия на мобильных устройствах (см. ниже), скрипт прекращает свою работу.
3.  Скрипт проверяет, когда пользователь последний раз посещал страницу, используя `localStorage`.
4.  Если это первый визит пользователя или с момента последнего визита прошло больше 30 дней (по умолчанию), скрипт начинает ожидать клик пользователя.
5.  Когда пользователь кликает по элементу, соответствующему определенным критериям (например, контейнер сайта, изображение), скрипт открывает посадочную страницу в новой вкладке.
6.  Скрипт сохраняет текущую дату в `localStorage` как дату последнего визита.
7.  Скрипт автоматически очищает `localStorage` раз в два месяца для предотвращения накопления устаревших данных.

## Подключение

1.  Установите и активируйте плагин [Advanced Custom Fields (ACF)](https://www.advancedcustomfields.com/) в WordPress.

2.  Создайте группу полей ACF (например, "Настройки посадочной страницы") и добавьте ее к нужным записям (например, ко всем записям типа "Статья").

3.  Добавьте следующие пользовательские поля ACF (см. раздел "Пользовательские поля ACF" для подробной информации):
    *   `landing_page_url` - URL посадочной страницы.
    *   `landing_page_mobile` - Разрешить открытие на мобильных устройствах (true/false).

4.  Добавьте следующий код в файл `functions.php` вашей темы WordPress:

    ```php
    <?php
    /**
     * Enqueue landing page script
     */
    function my_theme_enqueue_scripts() {
        wp_register_script( 'landing-page-script', get_template_directory_uri() . '/js/landing.min.js', array(), '1.0', true );
        wp_enqueue_script( 'landing-page-script' );
    }
    add_action( 'wp_enqueue_scripts', 'my_theme_enqueue_scripts' );

    /**
     * Add landing page meta tag
     */
    function add_landing_page_meta_tag() {
        if (function_exists('get_field') && !is_front_page() && !is_home() && is_single()) {
            $landing_page_url = get_field('landing_page_url');
            $landing_page_mobile = get_field('landing_page_mobile');

            if ($landing_page_url) {
                $mobile_attr = $landing_page_mobile ? 'data-mobile="true"' : 'data-mobile="false"';
                echo '<meta name="landing-page-url" content="' . esc_url($landing_page_url) . '" ' . $mobile_attr . '">' . "\\n";
            }
        }
    }
    add_action('wp_head', 'add_landing_page_meta_tag');
    ?>
    ```
   **Важно:** Убедитесь, что вы заменили `/js/landing.min.js` на фактический путь к вашему файлу `landing.min.js` в теме WordPress.
5.  Заполните пользовательские поля ACF для каждой записи, для которой вы хотите использовать скрипт.

## Пользовательские поля ACF

Вам необходимо создать следующие пользовательские поля ACF:

*   **`landing_page_url`**
    *   Тип поля: URL
    *   Имя поля: `landing_page_url`
    *   Описание: URL посадочной страницы, которая будет открываться по клику.

*   **`landing_page_mobile`**
    *   Тип поля: True / False
    *   Имя поля: `landing_page_mobile`
    *   Описание: Определяет, следует ли открывать посадочную страницу на мобильных устройствах. Если установлено значение `true`, скрипт будет работать на мобильных устройствах. Если установлено значение `false` (или не установлено), скрипт не будет работать на мобильных устройствах.

## Обработка ошибок

Скрипт обрабатывает следующие ошибки:

*   **`localStorage` недоступен:** Если `localStorage` недоступен (например, в режиме приватного просмотра), скрипт выводит сообщение об ошибке в консоль и прекращает попытки чтения или записи в `localStorage`. В этом случае, отслеживание последнего визита не будет работать, и посадочная страница может открываться чаще, чем ожидалось.
*   **Невалидный URL:** Если URL посадочной страницы, указанный в мета-теге, является невалидным, скрипт выводит сообщение об ошибке в консоль и прекращает свою работу. Это предотвращает попытки открытия несуществующих страниц.

## Очистка localStorage

Скрипт автоматически очищает `localStorage` раз в два месяца, удаляя записи `landingPageLastVisit` и `lastStorageClearDate`. Это необходимо для предотвращения накопления устаревших данных и экономии места в хранилище браузера.

## Отладка

Если скрипт не работает должным образом, выполните следующие действия:

1.  **Проверьте консоль браузера на наличие ошибок.** Любые ошибки JavaScript будут отображаться в консоли.
2.  **Убедитесь, что URL посадочной страницы в мета-теге указан правильно.** Скопируйте URL из мета-тега и вставьте его в адресную строку браузера, чтобы убедиться, что он работает.
3.  **Проверьте настройки блокировщика всплывающих окон.** Убедитесь, что ваш браузер не блокирует всплывающие окна с вашего сайта.
4.  **Убедитесь, что пользовательские поля ACF заполнены для текущей записи.**
5.  **Проверьте правильность подключения скрипта и функции мета-тега в `functions.php`.**

## Лицензия

Этот код распространяется под лицензией [MIT License](LICENSE).

---